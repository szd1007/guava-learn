# 交易领域网关

## 一、Gateway

API Gateway（APIGW / API网关），顾名思义，**是出现在系统边界上的一个面向API的、串行集中式的强管控服务**，这里的边界是服务系统的边界，是**隔离企业内部业务系统和外部系统调用的屏障**。

## 二、Gateway作用

#### 2.1领域间的隔离

网关层对外部和内部进行了隔离。当业务线较多时，可以将重要的业务分配到更优质的资源组(例如：机器性能、线程池的大小)，将一般业务放到普通资源组，这样可以更好的服务不同的业务场景。**清晰的把对内对外的接口划分开，使服务界限更明确，职责更简单化**。

#### 2.2多方领域解耦

系统架构层面：

##### 2.2.1、解耦功能与非功能

服务提供给外部访问时，除了实现业务逻辑功能外，还面临许多类似服务分流、业务隔离等非功能性的要求。这些**非功能逻辑，不能与业务逻辑的开发混在一起，需要隔离。**

##### 2.2.2、解耦调用方与服务提供者

  通过解耦，服务层可以使用**统一的接口、协议和报文格式**来暴露服务，而不必考虑客户端的多种形态。增加服务易用性。让调用方不用关心服务提供者服务内部的关系。

#### 2.3易于动态扩展

**通过网关层聚合，可以更好的扩展通用功能**。一些非业务性的问题，例如**日志**、安全、负载均衡策略、鉴权、**灰度上线**、限流、**监控**、熔断、api管理等等。这些功能会以插件化的方式聚拢在网关层，方便日常维护。

> 基于系统架构层面，简单总结下拆分后网关的实际职能

![image](https://note.youdao.com/yws/public/resource/c36800b3955faa6b14f264bedc7eb2c7/xmlnote/5B13D28B3B954DF0839DD0EB5D8D5C5E/16888)

  

### 三、设计目标

#### 3.1当前系统现状
![image](https://note.youdao.com/yws/public/resource/c36800b3955faa6b14f264bedc7eb2c7/xmlnote/7828E35878694976AEF169157DED7444/16885)


**系统痛点：**

1、随着业务的发展，服务越来越多，**调用关系难以维护，呈网状结构**。

2、各个服务之间的职责界限、**对外对内接口分工不明确**，耦合。

3、对易用性、api管理、监控、限流、熔断 等等功能很难统一扩展与管理。

#### 3.2新系统架构
![image](https://note.youdao.com/yws/public/resource/c36800b3955faa6b14f264bedc7eb2c7/xmlnote/DF92F03EF4CC4A529674C3DC9D7DCCF0/16882)


**设计要素：**

- **流量管控**：实现微服流量管理，可以定义多种限流策略,分流策略。

- **日志管理**：统一的日志记录。可以多维度统计分析。

- **负载均衡**:   为服务提供稳定性保障。

- **统一监控**：**记录请求响应数据，API耗时分析，性能监控。**

- **API鉴权**：   权限身份认证，api生命周期管理。保证交易API安全性。

- **IP黑白名单**：控制防止恶意请求。

- **灰度发布**： **线上灰度部署，可以减小上线风险。**

- **动态路由**： 能够灵活配置多种策略锁定目标微服务并将请求进行转发。保证一定稳定性和隔离性。

- **服务熔断**：下游服务因访问压力过大而响应变慢或失败，暂时切断对下游服务的调用。

- **服务降级**：**当某个服务熔断之后，服务将不再被调用，此时客户端可以自己准备一个本地的fallback（回退）回调，返回一个缺省值。**

- **统一异常**：**对异常进行统一处理,做到统一监控。**
- **接口缓存**：针对一些常用查询接口，在大流量压力的情况下可以设定相应缓存策略
  







### 四 设计思路与折衷

#### 4.1 设计原则

- **业务线级别稳定保障**

	本次网关的主要目的之一就是要**梳理现有交易使用的业务方**，进行统一管控。除了要做到大的业务方区分之外，还要细化到业务使用场景上去。做到**业务场景级别的实时监控**。

- **降低业务方接入成本**

	为了确保业务能快速接入，针对现有对外暴露的接口，做到业务方低成本迁移，同时也要减少组内同学改造网关的工作量。

- **高度灵活的管控**

	系统设计目标要依赖配置中心，做到**对线上问题及时快速响应**，在不上线的情况快速进行开关切换；ab测试逻辑线上配置化等
	
#### 4.2 实现方案

- 4.2.1 **制定一套全新api标准规范**

	推进网关向**标准化、模块化**方向发展。指定一套标准网关接入规范、包含请求返回结构体，统一的错误码规则、统一的exception以及相关命名规范标准化。

- 4.2.2 **支持现有接口业务方平滑接入**

	网关上线后针对新增接口严格按照新的网关规范进行接入；针对现有接口自动生成代理网关代码，**对应接口仅在原方法参数中添加网关管控context参数**，原有接口调用方只需更改到对应的新增网关接口即可，**原有业务逻辑不受影响**。
> 系统总体架构图

[![kRciSH.png](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/1EC5C0FF5F34499F928192E7D2BBD2A8/19914)](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/1EC5C0FF5F34499F928192E7D2BBD2A8/19914)


 
#### 4.3 核心设计

- 4.3.1 **网关filter插件化处理流程**

	为了方便后续网关升级，在最初版本引入责任链模式将访问log、权限控制、监控等请求进行功能划分。整体filter分为pre，routing，post，error四种类型。不同的路由阶段执行相应的filter处理。
[![kT0aF0.png](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/04CD9615AD81450E9A3DAFB90B7B0A32/19912)](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/04CD9615AD81450E9A3DAFB90B7B0A32/19912)

- 4.3.2 **网关api桩代码自动处理逻辑**

	在组内同学对contract进行注解梳理后，自动生成网关代理stub代码。减少组内同学工作量。
[![kTBVpT.png](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/5951E11566B647DE993068C29B6DC5B1/19906)](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/5951E11566B647DE993068C29B6DC5B1/19906)

- 4.3.3 **配置中心领域划分**，通用配置项，开关配置, filter链版本控制实现网关核心功能动态升级

  配置中心采用分为两级：1 **通用配置模板**，这个配置项是所有网关通用的一些配置:业务方标识、功能开关 2 **领域具体配置**。在此级可以配置领域内相关配置：灰度策略等。如果与通用配置模板存在相同配置项时以该级别配置为准。

[![kTr5lT.png](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/75EB54809BE8480FA26ACC3ED7961C47/19908)](https://note.youdao.com/yws/public/resource/278b391bfc9662d4b7609005c0dd81ee/xmlnote/75EB54809BE8480FA26ACC3ED7961C47/19908)


## 五 实施阶段

#### 5.1 整体实施步骤

![image](https://note.youdao.com/yws/public/resource/c36800b3955faa6b14f264bedc7eb2c7/xmlnote/C2A595249E0D49338CD65E6D63BDB34C/16709)

##### 5.1.1 第一阶段：网关基础建设
1. 服务**网关标准**的制定；
2. 明确划分业务领域，确定领域网关；
3. 暴露接口平移到网关；


- **领域划分**

> 目前的领域划分为：交易、支付、促销、运营玩法、三方服务 等。

![image](https://note.youdao.com/yws/public/resource/c36800b3955faa6b14f264bedc7eb2c7/xmlnote/EA72E186FF964421B1F4B33E0632B2C9/16668)



- **确定领域网关**

交易、支付、运营需要先采用领域网关方式改造，++具体领域网关见附件++。
![image](https://note.youdao.com/yws/public/resource/c36800b3955faa6b14f264bedc7eb2c7/xmlnote/379574D94E344E3BBEB630FCA0A2B834/16679)



- **统计已暴露接口**

1. 通过服务管理平台统计，具体【接口统计操作手册】
2. 在各工程中写filter，收集外部调用信息

**网关标准代码**

> gateway-demo目录结构
```
├── contract    API接口
│   ├── default         
│   │   ├── api             推荐接口
│   │   └── api.deprecated  平移接口实现
│   │
│   └── web     Web接口
│
└── service     服务端
    ├── getway.deprecated   平移接口实现
    ├── getway.remote       新接口实现
    └── getway.web          Web接口实现
```


- **迁移接口到网关**
1. 各**服务负责人**在原接口上添加自定义注解，在服务中添加统一的filter收集外部调用信息；
2. 迁移脚本根据自定义注解自动生成平移接口代码，将生成好的接口代码发布上线。
3. 实现网关基于业务方编码的基本权限管控策略。



##### 5.1.2 第二阶段：推动业务方接入

 推动业务方迁移到新的平移接口，按照业务方以及具体业务线分配code


- **推动业务方接入**

1. **明确各领域网关的职责**，输出网关接口文档，减少业务方的服务依赖数量，提前告知相关服务负责人；
2. **提供完善的迁移对照表格**，让每次上新需求的时候顺带切到新接口；
步骤：a) 原接口最后加固定DTO； b)申请调用权限；
3. 定期统计老接口的迁移进度，并发送邮件告知相关负责人。


- **接口文档**
1. 明确领域职责，交易下单前、交易流程、支付、运营等；
1. 完善网关接口文档，业务方接入直接参照接口文档。


- **标准接口**
1. 新添加的功能接口，统一由领域网关层对外发布，按照网关规范提供接口，同时更新接口文档。


##### 5.1.3 第三阶段：交易网关后续完善

- **业务粒度监控**
1. 业务编码级别监控可视化
2. 完善日志、错误码等监控。**配套的告警机制**

- **细粒度管控**

1. 负载均衡
2. 对**上游**进行限流，对**下游**进行熔断、降级；
3. 灰度发布（AB侧上线），依赖服务管理平台分组tag。



## 六 项目风险

#### 业务方不愿意接入
1. 尽可能让业务方少改；
2. 完善接入对照手册，让接入简单；
3. 定期发送接入进度邮件，告知相关负责人。

#### 编码使用不规范
1. 原因：业务方为了省事儿，同一个Code重复使用；


#### 性能损耗
1. SCF调用链会加长，带来性能损耗；
2. 各领域内做局部优化，提高接口性能。



